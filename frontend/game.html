<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚²ãƒ¼ãƒ ã§ã‚ãã¶ - ã¦ã¥ãã‚ŠMNIST</title>

  <!-- Primary Meta Tags -->
  <meta name="title" content="ã‚²ãƒ¼ãƒ ã§ã‚ãã¶ - ã¦ã¥ãã‚ŠMNIST">
  <meta name="description" content="ã˜ã¶ã‚“ã®ã‚‚ã˜ã§ã•ã‚“ã™ã†ã‚‚ã‚“ã ã„ã«ã¡ã‚‡ã†ã›ã‚“">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœ‹</text></svg>">

  <!-- Theme Color -->
  <meta name="theme-color" content="#fef3c7">

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="globalLoadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50" style="display: none;">
    <div class="text-center">
      <div class="loading-spinner mb-4"></div>
      <p id="loadingMessage" class="text-xl font-bold">ã‚ˆã¿ã“ã¿ã¡ã‚…ã†...</p>
    </div>
  </div>

  <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° -->
  <script>
  window.addEventListener('error', (e) => {
    if (e.message.includes('cdn') || e.message.includes('unpkg')) {
      showErrorMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã›ã¤ãããŒã²ã¤ã‚ˆã†ã§ã™ã€‚\nWi-Fiã‚„ãƒ¢ãƒã‚¤ãƒ«ã¤ã†ã—ã‚“ã‚’ã‹ãã«ã‚“ã—ã¦ãã ã•ã„ã€‚');
    }
  }, true);

  function showErrorMessage(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    errorDiv.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
        <div class="text-4xl mb-4">âš ï¸</div>
        <p class="text-lg font-bold mb-4 whitespace-pre-line">${message}</p>
        <button onclick="location.reload()" class="btn-primary">
          ã‚‚ã†ã„ã¡ã© ã‚ˆã¿ã“ã‚€
        </button>
      </div>
    `;
    document.body.appendChild(errorDiv);
  }

  function showLoading(message = 'ã‚ˆã¿ã“ã¿ã¡ã‚…ã†...') {
    const overlay = document.getElementById('globalLoadingOverlay');
    const messageEl = document.getElementById('loadingMessage');
    if (overlay && messageEl) {
      messageEl.textContent = message;
      overlay.style.display = 'flex';
    }
  }

  function hideLoading() {
    const overlay = document.getElementById('globalLoadingOverlay');
    if (overlay) {
      overlay.style.display = 'none';
    }
  }

  // 28x28ç”»åƒã‚’Canvasã«è¡¨ç¤º
  function displayImageOnCanvas(canvasId, imageData, size) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return false;

    canvas.width = size;
    canvas.height = size;

    const ctx = canvas.getContext('2d');
    const imgData = ctx.createImageData(28, 28);

    for (let i = 0; i < imageData.length; i++) {
      const value = Math.round(imageData[i] * 255);
      imgData.data[i * 4] = value;
      imgData.data[i * 4 + 1] = value;
      imgData.data[i * 4 + 2] = value;
      imgData.data[i * 4 + 3] = 255;
    }

    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = 28;
    tempCanvas.height = 28;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.putImageData(imgData, 0, 0);

    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(tempCanvas, 0, 0, 28, 28, 0, 0, size, size);

    return true;
  }
  </script>

  <div class="container mx-auto px-4 py-4" x-data="gameApp()">
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="mb-4">
      <div class="flex gap-2 bg-white rounded-lg p-2 shadow">
        <a href="collect.html" class="flex-1">
          <button class="w-full py-3 px-4 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
            ğŸ“ ã‚‚ã˜ã‚’ã‹ã
          </button>
        </a>
        <a href="train.html" class="flex-1">
          <button class="w-full py-3 px-4 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
            ğŸ§  ãŒãã—ã‚…ã†
          </button>
        </a>
        <a href="game.html" class="flex-1">
          <button class="w-full py-3 px-4 rounded-lg bg-indigo-500 text-white font-bold">
            ğŸ® ã‚²ãƒ¼ãƒ 
          </button>
        </a>
      </div>
      <div class="mt-2 text-center">
        <a href="index.html" class="text-sm text-gray-600 hover:text-gray-900">
          â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã‚‚ã©ã‚‹
        </a>
      </div>
    </div>

    <!-- æ¡ä»¶ãƒã‚§ãƒƒã‚¯ -->
    <template x-if="!canPlayGame">
      <div class="card">
        <h2 class="text-xl font-bold mb-4 text-center">âš ï¸ ã‚²ãƒ¼ãƒ ã‚’ã¯ã˜ã‚ã‚‰ã‚Œã¾ã›ã‚“</h2>

        <div class="space-y-4">
          <!-- ãƒ‡ãƒ¼ã‚¿æ¡ä»¶ -->
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
            <div>
              <div class="font-bold">ãƒ‡ãƒ¼ã‚¿ã—ã‚…ã†ã—ã‚…ã†</div>
              <div class="text-sm text-gray-600" x-text="`${dataStatus.total}/30 ã‚µãƒ³ãƒ—ãƒ«`"></div>
            </div>
            <div x-text="dataStatus.valid ? 'âœ“' : 'âœ—'"
                 :class="dataStatus.valid ? 'text-green-600 text-3xl' : 'text-red-600 text-3xl'">
            </div>
          </div>

          <!-- CNNæ¡ä»¶ -->
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
            <div>
              <div class="font-bold">CNN ãŒãã—ã‚…ã†</div>
              <div class="text-sm text-gray-600">ã™ã†ã˜ã«ã‚“ã—ã</div>
            </div>
            <div x-text="cnnTrained ? 'âœ“' : 'âœ—'"
                 :class="cnnTrained ? 'text-green-600 text-3xl' : 'text-red-600 text-3xl'">
            </div>
          </div>
        </div>

        <!-- èª˜å°ãƒœã‚¿ãƒ³ -->
        <div class="mt-6 space-y-3">
          <template x-if="!dataStatus.valid">
            <a href="collect.html">
              <button class="btn-secondary w-full">ğŸ“ ã‚‚ã˜ã‚’ã‹ã ãŒã‚ã‚“ã¸</button>
            </a>
          </template>

          <template x-if="!cnnTrained">
            <a href="train.html">
              <button class="btn-secondary w-full">ğŸ§  ãŒãã—ã‚…ã† ãŒã‚ã‚“ã¸</button>
            </a>
          </template>
        </div>
      </div>
    </template>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
    <template x-if="canPlayGame">
      <div>
        <!-- ã‚¹ã‚³ã‚¢ -->
        <div class="card text-center">
          <h2 class="text-lg font-bold mb-2">ã‚¹ã‚³ã‚¢</h2>
          <div class="text-4xl font-bold text-primary" x-text="score"></div>
        </div>

        <!-- å•é¡Œè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="card">
          <h3 class="text-center text-2xl font-bold mb-4">ã‚‚ã‚“ã ã„</h3>

          <!-- å•é¡Œç”»åƒè¡¨ç¤º -->
          <div class="flex items-center justify-center gap-4 mb-4">
            <!-- num1ç”»åƒ -->
            <canvas id="num1Canvas" width="56" height="56" class="border-2 border-gray-300 rounded"></canvas>

            <!-- æ¼”ç®—å­ -->
            <span class="text-4xl font-bold mx-2" x-text="currentQuestion ? currentQuestion.operator : '+'"></span>

            <!-- num2ç”»åƒ -->
            <canvas id="num2Canvas" width="56" height="56" class="border-2 border-gray-300 rounded"></canvas>

            <!-- = -->
            <span class="text-4xl font-bold mx-2">=</span>

            <!-- ç­”ãˆ -->
            <span class="text-4xl font-bold">?</span>
          </div>
        </div>

        <!-- å›ç­”å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div class="card">
          <h3 class="text-center text-lg font-bold mb-4">ã“ãŸãˆã‚’ã‹ã„ã¦ã­</h3>

          <div class="flex justify-center mb-4">
            <!-- 1ã®ä½Canvas -->
            <div class="text-center">
              <div class="canvas-container">
                <canvas id="answerCanvas" width="280" height="280"></canvas>
              </div>
            </div>
          </div>

          <!-- ãƒœã‚¿ãƒ³ -->
          <div class="flex gap-4 justify-center">
            <button @click="clearAnswer()" class="btn-secondary">
              ğŸ—‘ï¸ ã‘ã™
            </button>
            <button @click="submitAnswer()" class="btn-primary">
              âœ… ã“ãŸãˆã‚‹
            </button>
          </div>
        </div>

      </div>
    </template>
  </div>

  <!-- Scripts -->
  <script src="js/api.js"></script>
  <script src="js/canvas.js"></script>
  <script>
    function gameApp() {
      return {
        dataStatus: {
          valid: false,
          total: 0,
          perDigit: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        },
        cnnTrained: false,
        canPlayGame: false,
        score: 0,
        canvasHandler: null,
        currentQuestion: null,

        async init() {
          showLoading('ã˜ã‚‡ã†ã‘ã‚“ã‚’ã‹ãã«ã‚“ã¡ã‚…ã†...');

          try {
            await this.checkRequirements();

            if (this.canPlayGame) {
              // Canvasã‚’åˆæœŸåŒ–
              this.canvasHandler = initCanvas('answerCanvas', 280);

              showLoading('ã‚‚ã‚“ã ã„ã‚’ã•ãã›ã„ã¡ã‚…ã†...');
              // æœ€åˆã®å•é¡Œã‚’ç”Ÿæˆ
              await this.startGame();
            }

            hideLoading();
          } catch (error) {
            hideLoading();
            console.error('Initialization error:', error);
            alert('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
        },

        async checkRequirements() {
          // ãƒ‡ãƒ¼ã‚¿æ¡ä»¶ãƒã‚§ãƒƒã‚¯
          this.dataStatus = await checkDataRequirements();

          // ãƒ¢ãƒ‡ãƒ«å­¦ç¿’æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ï¼ˆCNNã®ã¿ï¼‰
          const modelsStatus = await getModelsStatus();
          this.cnnTrained = modelsStatus.cnn.trained;

          // å…¨æ¡ä»¶ã‚’æº€ãŸã™ã‹ï¼ˆãƒ‡ãƒ¼ã‚¿æ¡ä»¶ + CNNå­¦ç¿’æ¸ˆã¿ï¼‰
          this.canPlayGame = this.dataStatus.valid && this.cnnTrained;
        },

        async startGame() {
          try {
            // å•é¡Œã‚’ç”Ÿæˆ
            this.currentQuestion = await generateQuestion("mixed");

            // å•é¡Œç”»åƒã‚’è¡¨ç¤º
            this.displayQuestion();

            // å›ç­”Canvasã‚’ã‚¯ãƒªã‚¢
            this.clearAnswer();
          } catch (error) {
            console.error('Failed to start game:', error);
            alert('å•é¡Œã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
        },

        displayQuestion() {
          if (!this.currentQuestion) return;

          // num1ç”»åƒã‚’Canvasã«è¡¨ç¤º
          const num1Success = displayImageOnCanvas('num1Canvas', this.currentQuestion.num1Image, 56);
          const num2Success = displayImageOnCanvas('num2Canvas', this.currentQuestion.num2Image, 56);

          if (!num1Success || !num2Success) {
            console.error('Failed to display question digits');
            alert('æ•°å­—ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          }
        },

        clearAnswer() {
          if (this.canvasHandler) {
            this.canvasHandler.clear();
          }
        },

        async submitAnswer() {
          if (!this.currentQuestion) {
            alert('ã‚‚ã‚“ã ã„ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
          }

          if (!this.canvasHandler) {
            alert('ã‚­ãƒ£ãƒ³ãƒã‚¹ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
          }

          // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const imageData = this.canvasHandler.getImageData();
          const isBlank = imageData.every(val => val === 0);

          if (isBlank) {
            alert('ã“ãŸãˆã‚’ã‹ã„ã¦ãã ã•ã„');
            return;
          }

          try {
            showLoading('ã“ãŸãˆã‚’ã‹ãã«ã‚“ã¡ã‚…ã†...');

            // ã‚µãƒ¼ãƒãƒ¼ã«å›ç­”ã‚’é€ä¿¡
            const result = await submitAnswer(
              this.currentQuestion.questionId,
              imageData,
              null
            );

            hideLoading();

            // ã‚¹ã‚³ã‚¢æ›´æ–°
            if (result.correct) {
              this.score++;
              alert(`ğŸ‰ ã›ã„ã‹ã„ï¼\nã‚ãªãŸã®ã“ãŸãˆ: ${result.recognizedAnswer}\nã‚¹ã‚³ã‚¢: ${this.score}`);
            } else {
              alert(`âŒ ã–ã‚“ã­ã‚“...\nã‚ãªãŸã®ã“ãŸãˆ: ${result.recognizedAnswer}\nã›ã„ã‹ã„: ${result.correctAnswer}\nã‚¹ã‚³ã‚¢: ${this.score}`);
            }

            // æ¬¡ã®å•é¡Œã¸
            showLoading('ã¤ãã®ã‚‚ã‚“ã ã„ã‚’ã•ãã›ã„ã¡ã‚…ã†...');
            await this.startGame();
            hideLoading();

          } catch (error) {
            hideLoading();
            console.error('Failed to submit answer:', error);
            alert('å›ç­”ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
          }
        }
      }
    }
  </script>
</body>
</html>
