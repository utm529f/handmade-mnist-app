<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚‚ã˜ã‚’ã‹ã - ã¦ã¥ãã‚ŠMNIST</title>

  <!-- Primary Meta Tags -->
  <meta name="title" content="ã‚‚ã˜ã‚’ã‹ã - ã¦ã¥ãã‚ŠMNIST">
  <meta name="description" content="ã™ã†ã˜ã‚’ã‹ã„ã¦ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã«ãŠã¼ãˆã¦ã‚‚ã‚‰ãŠã†">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>âœ‹</text></svg>">

  <!-- Theme Color -->
  <meta name="theme-color" content="#fef3c7">

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="globalLoadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50" style="display: none;">
    <div class="text-center">
      <div class="loading-spinner mb-4"></div>
      <p id="loadingMessage" class="text-xl font-bold">ã‚ˆã¿ã“ã¿ã¡ã‚…ã†...</p>
    </div>
  </div>

  <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° -->
  <script>
  window.addEventListener('error', (e) => {
    if (e.message.includes('cdn') || e.message.includes('unpkg')) {
      showErrorMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã›ã¤ãããŒã²ã¤ã‚ˆã†ã§ã™ã€‚\nWi-Fiã‚„ãƒ¢ãƒã‚¤ãƒ«ã¤ã†ã—ã‚“ã‚’ã‹ãã«ã‚“ã—ã¦ãã ã•ã„ã€‚');
    }
  }, true);

  function showErrorMessage(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    errorDiv.innerHTML = `
      <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center">
        <div class="text-4xl mb-4">âš ï¸</div>
        <p class="text-lg font-bold mb-4 whitespace-pre-line">${message}</p>
        <button onclick="location.reload()" class="btn-primary">
          ã‚‚ã†ã„ã¡ã© ã‚ˆã¿ã“ã‚€
        </button>
      </div>
    `;
    document.body.appendChild(errorDiv);
  }

  function showLoading(message = 'ã‚ˆã¿ã“ã¿ã¡ã‚…ã†...') {
    const overlay = document.getElementById('globalLoadingOverlay');
    const messageEl = document.getElementById('loadingMessage');
    if (overlay && messageEl) {
      messageEl.textContent = message;
      overlay.style.display = 'flex';
    }
  }

  function hideLoading() {
    const overlay = document.getElementById('globalLoadingOverlay');
    if (overlay) {
      overlay.style.display = 'none';
    }
  }
  </script>

  <div class="container mx-auto px-4 py-4" x-data="collectApp()">
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="mb-4">
      <div class="flex gap-2 bg-white rounded-lg p-2 shadow">
        <a href="collect.html" class="flex-1">
          <button class="w-full py-3 px-4 rounded-lg bg-indigo-500 text-white font-bold">
            ğŸ“ ã‚‚ã˜ã‚’ã‹ã
          </button>
        </a>
        <a href="train.html" class="flex-1">
          <button class="w-full py-3 px-4 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
            ğŸ§  ãŒãã—ã‚…ã†
          </button>
        </a>
        <a href="game.html" class="flex-1">
          <button class="w-full py-3 px-4 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 transition-all">
            ğŸ® ã‚²ãƒ¼ãƒ 
          </button>
        </a>
      </div>
      <div class="mt-2 text-center">
        <a href="index.html" class="text-sm text-gray-600 hover:text-gray-900">
          â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã‚‚ã©ã‚‹
        </a>
      </div>
    </div>

    <!-- æŒ‡ç¤ºæ–‡ -->
    <div class="card text-center">
      <h2 class="text-3xl font-bold mb-2">
        ã€Œ<span class="text-primary" x-text="currentDigit"></span>ã€ã‚’ã‹ã„ã¦ã­
      </h2>
      <p class="text-sm text-gray-600">
        <span x-text="digitProgress[currentDigit]"></span> / 10 ã¾ã„
      </p>
    </div>

    <!-- æ•°å­—åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
    <div class="card mt-4">
      <h3 class="text-sm font-bold mb-2 text-gray-600">ã™ã†ã˜ã‚’ãˆã‚‰ã¶</h3>

      <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: 1è¡Œè¡¨ç¤º -->
      <div class="hidden sm:grid grid-cols-10 gap-2">
        <template x-for="digit in [0,1,2,3,4,5,6,7,8,9]" :key="digit">
          <button
            @click="switchDigit(digit)"
            :class="getDigitButtonClass(digit)"
            class="h-14 flex flex-col items-center justify-center"
          >
            <div class="text-lg font-bold" x-text="getDigitButtonText(digit)"></div>
            <div class="text-xs" x-text="getDigitButtonSubText(digit)"></div>
          </button>
        </template>
      </div>

      <!-- ãƒ¢ãƒã‚¤ãƒ«: 2è¡Œè¡¨ç¤º -->
      <div class="grid grid-cols-5 gap-2 sm:hidden">
        <template x-for="digit in [0,1,2,3,4,5,6,7,8,9]" :key="digit">
          <button
            @click="switchDigit(digit)"
            :class="getDigitButtonClass(digit)"
            class="h-14 flex flex-col items-center justify-center"
          >
            <div class="text-lg font-bold" x-text="getDigitButtonText(digit)"></div>
            <div class="text-xs" x-text="getDigitButtonSubText(digit)"></div>
          </button>
        </template>
      </div>
    </div>

    <!-- Canvas -->
    <div class="canvas-container mx-auto" style="width: fit-content;">
      <canvas id="drawCanvas"></canvas>
    </div>

    <!-- ãƒœã‚¿ãƒ³ -->
    <div class="flex gap-4 justify-center mt-6">
      <button @click="clearCanvas()" class="btn-secondary">
        ğŸ—‘ï¸ ã‘ã™
      </button>
      <button @click="saveAndNext()" class="btn-primary">
        âœ… ã¤ãã¸
      </button>
    </div>

    <!-- é€²æ—è¡¨ç¤º -->
    <div class="card mt-6">
      <h3 class="text-lg font-bold mb-3">ã—ã‚“ã¡ã‚‡ã</h3>

      <!-- ç¾åœ¨ã®æ•°å­—ã®é€²æ— -->
      <div class="mb-4">
        <div class="flex justify-between text-sm mb-1">
          <span>ã™ã†ã˜ <span x-text="currentDigit"></span></span>
          <span x-text="`${digitProgress[currentDigit]}/10`"></span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill"
               :style="`width: ${(digitProgress[currentDigit] / 10) * 100}%`">
          </div>
        </div>
      </div>

      <!-- å…¨ä½“ã®é€²æ— -->
      <div class="mb-4">
        <div class="flex justify-between text-sm mb-1">
          <span>ãœã‚“ãŸã„</span>
          <span x-text="`${totalSamples}/100`"></span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill"
               :style="`width: ${(totalSamples / 100) * 100}%`">
          </div>
        </div>
      </div>

      <!-- å„æ•°å­—ã®åé›†çŠ¶æ³ -->
      <div class="mt-4">
        <h4 class="text-sm font-bold mb-2">ã—ã‚…ã†ã—ã‚…ã†ã˜ã‚‡ã†ãã‚‡ã†</h4>
        <div class="grid grid-cols-5 gap-2 text-xs">
          <template x-for="digit in [0,1,2,3,4,5,6,7,8,9]" :key="digit">
            <div class="text-center">
              <div class="font-bold" x-text="digit"></div>
              <div class="progress-bar h-2">
                <div class="progress-fill"
                     :style="`width: ${(digitProgress[digit] / 10) * 100}%`">
                </div>
              </div>
              <div x-text="`${digitProgress[digit]}/10`"></div>
            </div>
          </template>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="js/api.js"></script>
  <script src="js/canvas.js"></script>
  <script>
    function collectApp() {
      return {
        currentDigit: 0,
        digitProgress: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        totalSamples: 0,
        canvasHandler: null,

        async init() {
          try {
            // 1. Canvasã‚’åˆæœŸåŒ–
            this.canvasHandler = initCanvas('drawCanvas', 280);

            // 2. é€²æ—ã‚’èª­ã¿è¾¼ã¿
            console.log('Loading progress...');
            await this.loadProgress();

            // 3. æ¬¡ã®æ•°å­—ã‚’è¦‹ã¤ã‘ã‚‹
            this.findNextDigit();
            console.log('Initialization complete');
          } catch (error) {
            console.error('Initialization error:', error);
            alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          }
        },

        async loadProgress() {
          try {
            const dataStatus = await checkDataRequirements();
            this.digitProgress = dataStatus.perDigit;
            this.totalSamples = dataStatus.total;
          } catch (error) {
            console.error('Failed to load progress:', error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            this.digitProgress = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            this.totalSamples = 0;
            throw error;
          }
        },

        findNextDigit() {
          // 10æšæœªæº€ã®æœ€åˆã®æ•°å­—ã‚’æ¢ã™
          for (let digit = 0; digit < 10; digit++) {
            if (this.digitProgress[digit] < 10) {
              this.currentDigit = digit;
              return;
            }
          }
          // ã™ã¹ã¦10æšä»¥ä¸Šãªã‚‰0ã«æˆ»ã‚‹
          this.currentDigit = 0;
        },

        clearCanvas() {
          this.canvasHandler.clear();
        },

        switchDigit(digit) {
          this.clearCanvas();
          this.currentDigit = digit;
        },

        getDigitButtonClass(digit) {
          const count = this.digitProgress[digit];
          const isActive = this.currentDigit === digit;

          let baseClass = 'digit-button text-center rounded-lg font-bold transition-all duration-200 cursor-pointer ';

          // åé›†çŠ¶æ³ã«å¿œã˜ãŸè‰²
          if (count === 0) {
            baseClass += 'bg-gray-200 text-gray-500 ';
          } else if (count < 10) {
            baseClass += 'bg-yellow-400 text-white ';
          } else {
            baseClass += 'bg-emerald-500 text-white ';
          }

          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹
          if (isActive) {
            baseClass += 'ring-4 ring-indigo-500 ring-opacity-50 scale-105 ';
          }

          return baseClass;
        },

        getDigitButtonText(digit) {
          const count = this.digitProgress[digit];
          if (count >= 10) {
            return `${digit} âœ“`;
          }
          return digit;
        },

        getDigitButtonSubText(digit) {
          const count = this.digitProgress[digit];
          if (count > 0 && count < 10) {
            return `${count}/10`;
          }
          return '';
        },

        async saveAndNext() {
          const saveButton = event.target;
          const originalText = saveButton.textContent;
          saveButton.disabled = true;
          saveButton.textContent = 'ã»ãã‚“ã¡ã‚…ã†...';

          try {
            // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const imageData = this.canvasHandler.getImageData();

            // APIã«ä¿å­˜
            await saveSample(this.currentDigit, imageData);

            saveButton.textContent = 'âœ… ã»ãã‚“ã—ã¾ã—ãŸï¼';

            // é€²æ—ã‚’æ›´æ–°
            this.digitProgress[this.currentDigit]++;
            this.totalSamples++;

            // Canvasã‚’ã‚¯ãƒªã‚¢
            this.clearCanvas();

            // 10æšé”æˆã—ãŸã‚‰æ¬¡ã®æ•°å­—ã¸
            if (this.digitProgress[this.currentDigit] >= 10) {
              const previousDigit = this.currentDigit;
              this.findNextDigit();
              if (this.currentDigit !== previousDigit) {
                alert(`ã™ã†ã˜ ${previousDigit} ã®ã—ã‚…ã†ã—ã‚…ã†ãŒ10ã¾ã„ãŸã£ã›ã„ï¼\nã¤ãã¯ ${this.currentDigit} ã‚’ã‹ãã¾ã—ã‚‡ã†ã€‚`);
              }
            }

            setTimeout(() => {
              saveButton.textContent = originalText;
              saveButton.disabled = false;
            }, 500);

          } catch (error) {
            console.error('Save error:', error);
            alert('ã»ãã‚“ã«ã—ã£ã±ã„ã—ã¾ã—ãŸã€‚\nãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n' + (error.message || ''));
            saveButton.textContent = originalText;
            saveButton.disabled = false;
          }
        }
      }
    }
  </script>
</body>
</html>
